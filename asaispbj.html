<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 智能比价扫码器</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.js"></script>

    <style>
        /* 额外的动画样式 */
        .text-shadow-lg { text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        @keyframes scan {
          0% { top: 5%; opacity: 0; } 15% { opacity: 1; } 85% { opacity: 1; } 100% { top: 95%; opacity: 0; }
        }
        .ease-spring { transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        body { background-color: black; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- 0. 环境准备：解构 React 和 图标 ---
        const { useState, useRef, useEffect } = React;
        
        // 从全局 lucideReact 对象中获取你用到的图标
        const { ShoppingBag, Search, Zap, X, Lightbulb, ScanLine, TrendingDown, ExternalLink, Loader2, ShoppingCart } = lucide;

        // --- 1. 你的配置区域 ---
        // ⚠️ 记得在这里填入你刚刚申请的 Key
        const apiKey = "AIzaSyCoVsEx-iIVD7neiz0OMBK_TLMTnhmxagQ"; 

        // --- 2. 辅助函数 ---
        const getPixelDiff = (data1, data2) => {
          if (!data1 || !data2) return 100;
          let diff = 0;
          for (let i = 0; i < data1.length; i += 16) { 
            diff += Math.abs(data1[i] - data2[i]);
          }
          return diff / (data1.length / 16);
        };

        const generatePrices = (basePrice) => {
          if (!basePrice) basePrice = 99;
          
          const jdPrice = Math.floor(basePrice * (0.98 + Math.random() * 0.05));
          const tbPrice = Math.floor(basePrice * (0.95 + Math.random() * 0.1));
          const pddPrice = Math.floor(basePrice * (0.85 + Math.random() * 0.1));

          const platforms = [
            { id: 'jd', name: '京东自营', price: jdPrice, color: '#e1251b', url: 'https://search.jd.com/Search?keyword=' },
            { id: 'tb', name: '淘宝天猫', price: tbPrice, color: '#ff5000', url: 'https://s.taobao.com/search?q=' },
            { id: 'pdd', name: '拼多多', price: pddPrice, color: '#e02e24', url: 'https://mobile.yangkeduo.com/search_result.html?search_key=' },
          ];

          const minPrice = Math.min(...platforms.map(p => p.price));
          return platforms.map(p => ({ ...p, isCheapest: p.price === minPrice })).sort((a, b) => a.price - b.price);
        };

        // --- 3. 组件主体 ---
        function SmartPriceScanner() {
          const videoRef = useRef(null);
          const canvasRef = useRef(null);
          
          const [status, setStatus] = useState('idle'); 
          const [result, setResult] = useState(null); 
          const [priceList, setPriceList] = useState([]);
          const [error, setError] = useState(null);
          
          const lastFrameRef = useRef(null);
          const stabilityTimerRef = useRef(null);
          const isProcessingRef = useRef(false);

          // 启动摄像头
          useEffect(() => {
            const startCamera = async () => {
              try {
                // 尝试请求后置摄像头
                const stream = await navigator.mediaDevices.getUserMedia({
                  video:true
                  } 
                });
                if (videoRef.current) videoRef.current.srcObject = stream;
              } catch (err) {
                console.error(err);
                setError("无法访问摄像头，请检查：1. 是否允许权限 2. 网站是否为 HTTPS 或 localhost");
              }
            };
            startCamera();
            return () => clearTimers();
          }, []);

          const clearTimers = () => {
              if(stabilityTimerRef.current) clearTimeout(stabilityTimerRef.current);
          };

          // 运动检测循环
          useEffect(() => {
            const checkMotion = () => {
              if (!videoRef.current || !canvasRef.current || ['scanning', 'analyzing', 'success', 'cooldown'].includes(status)) {
                requestAnimationFrame(checkMotion);
                return;
              }

              const video = videoRef.current;
              // 确保视频已经开始播放且有数据
              if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const ctx = canvasRef.current.getContext('2d', { willReadFrequently: true });
                canvasRef.current.width = 100;
                canvasRef.current.height = 100;
                ctx.drawImage(video, 0, 0, 100, 100);
                const currentFrame = ctx.getImageData(0, 0, 100, 100).data;
                
                if (lastFrameRef.current) {
                  const diff = getPixelDiff(lastFrameRef.current, currentFrame);
                  if (diff < 6) {
                     if (!stabilityTimerRef.current && !isProcessingRef.current) {
                         setStatus('stabilizing');
                         stabilityTimerRef.current = setTimeout(triggerScan, 1200);
                     }
                  } else {
                     if (stabilityTimerRef.current) {
                         clearTimeout(stabilityTimerRef.current);
                         stabilityTimerRef.current = null;
                         setStatus('idle');
                     }
                  }
                }
                lastFrameRef.current = currentFrame;
              }
              requestAnimationFrame(checkMotion);
            };
            requestAnimationFrame(checkMotion);
          }, [status]);

          // 触发 AI 识别
          const triggerScan = async () => {
            if (!apiKey) {
                alert("请先在代码中填入 Gemini API Key！");
                setStatus('idle');
                return;
            }

            isProcessingRef.current = true;
            setStatus('scanning');
            stabilityTimerRef.current = null;

            try {
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg', 0.8);

                setTimeout(async () => {
                    setStatus('analyzing');
                    const aiData = await identifyWithGemini(base64);
                    
                    if (aiData && aiData.name) {
                        setResult({
                            name: String(aiData.name),
                            usage: String(aiData.usage || "暂无说明"),
                        });
                        setPriceList(generatePrices(aiData.price_estimate));
                        setStatus('success');
                    } else {
                        handleCooldown();
                    }
                }, 1500);

            } catch (e) {
                console.error(e);
                handleCooldown();
            }
          };

          // Gemini API 调用
          const identifyWithGemini = async (base64) => {
            try {
                const prompt = `
                Identify the main product. Return ONLY raw JSON:
                {
                    "name": "Short product name in Chinese",
                    "usage": "One sentence usage tip in Chinese",
                    "price_estimate": number (Approximate price in CNY, just an integer)
                }
                Example: {"name": "Logitech Mouse", "usage": "Great for gaming.", "price_estimate": 120}
                If unsure, return {"name": null}.
                `;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }] }] })
                    }
                );
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                // 清理 JSON markdown 标记
                const cleanText = text.replace(/```json|```/g, '').trim();
                return JSON.parse(cleanText);
            } catch (e) { 
                console.error("API Error:", e);
                return null; 
            }
          };

          const handleCooldown = () => {
              setStatus('cooldown');
              setResult(null);
              setTimeout(() => {
                  setStatus('idle');
                  isProcessingRef.current = false;
                  lastFrameRef.current = null;
              }, 2000);
          };

          const getBoxColor = () => {
              if (status === 'stabilizing') return 'border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.5)]';
              if (status === 'scanning') return 'border-blue-400 shadow-[0_0_40px_rgba(96,165,250,0.8)]';
              if (status === 'analyzing') return 'border-purple-500 shadow-[0_0_40px_rgba(168,85,247,0.8)]';
              if (status === 'success') return 'border-green-500 shadow-[0_0_40px_rgba(34,197,94,0.8)]';
              return 'border-white/40';
          };

          const getStatusText = () => {
              if (status === 'stabilizing') return '保持稳定...';
              if (status === 'scanning') return 'AI 识别中...';
              if (status === 'analyzing') return '全网比价中...';
              if (status === 'success') return '比价完成！';
              return '对准商品比价';
          };

          return (
            <div className="min-h-screen bg-black text-white overflow-hidden relative font-sans flex flex-col md:flex-row">
              
              {/* 背景层 */}
              <div className="absolute inset-0 z-0">
                 <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover opacity-60" />
                 <canvas ref={canvasRef} className="hidden" />
                 {error && <div className="absolute inset-0 flex items-center justify-center bg-black/80 text-red-500 p-4 text-center">{error}</div>}
              </div>

              {/* 左侧：扫描区 */}
              <div className="relative z-10 flex-1 flex items-center justify-center p-8">
                 <div className={`relative w-72 h-72 md:w-96 md:h-96 transition-all duration-500 ease-out border-[3px] rounded-3xl flex flex-col items-center justify-center ${getBoxColor()} ${status === 'stabilizing' ? 'scale-95' : 'scale-100'}`}>
                    {(status === 'scanning' || status === 'analyzing') && (
                        <div className={`absolute w-full h-1 shadow-[0_0_20px_currentColor] animate-[scan_1.5s_linear_infinite] ${status === 'analyzing' ? 'bg-purple-400 text-purple-400' : 'bg-blue-400 text-blue-400'}`}></div>
                    )}
                    
                    <div className="transition-all duration-300 transform">
                        {status === 'scanning' && <Search size={48} className="text-blue-400 animate-pulse" />}
                        {status === 'analyzing' && <ShoppingCart size={48} className="text-purple-400 animate-bounce" />}
                        {status === 'success' && <ShoppingBag size={48} className="text-green-500" />}
                    </div>

                    <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white/80 rounded-tl-xl -mt-1 -ml-1"></div>
                    <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white/80 rounded-tr-xl -mt-1 -mr-1"></div>
                    <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white/80 rounded-bl-xl -mb-1 -ml-1"></div>
                    <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white/80 rounded-br-xl -mb-1 -mr-1"></div>

                    <div className="absolute -bottom-12 text-lg font-bold tracking-widest text-shadow-lg">{getStatusText()}</div>
                 </div>
              </div>

              {/* 右侧：比价结果面板 */}
              <div className={`relative z-20 w-full md:w-[420px] transition-transform duration-500 ease-spring ${status === 'success' ? 'translate-y-0 md:translate-x-0' : 'translate-y-full md:translate-y-0 md:translate-x-full'} fixed md:relative bottom-0 md:right-0`}>
                
                {result && (
                    <div className="h-full flex flex-col justify-end md:justify-center p-4 md:p-6">
                        <div className="bg-white text-gray-900 rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden border-t-4 md:border-4 border-green-500">
                            
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-4 border-b border-gray-100 pb-4">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">识别成功</span>
                                            <span className="text-xs text-gray-400">AI 估价: ¥{priceList[1]?.price}</span>
                                        </div>
                                        <h2 className="text-2xl font-black text-gray-900 leading-tight">{result.name}</h2>
                                    </div>
                                    <button onClick={handleCooldown} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X size={20} className="text-gray-400" /></button>
                                </div>

                                <div className="bg-yellow-50 p-3 rounded-lg mb-6 flex gap-3 items-start">
                                    <Lightbulb className="text-yellow-600 shrink-0 mt-0.5" size={16} />
                                    <p className="text-xs text-yellow-800 font-medium leading-relaxed">{result.usage}</p>
                                </div>

                                <div className="space-y-3 mb-6">
                                    <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">全网实时比价 (模拟)</div>
                                    {priceList.map((item) => (
                                        <a 
                                            key={item.id} 
                                            href={`${item.url}${encodeURIComponent(result.name)}`} 
                                            target="_blank"
                                            rel="noreferrer"
                                            className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all hover:scale-[1.02] active:scale-95 group ${item.isCheapest ? 'border-red-500 bg-red-50 shadow-md' : 'border-gray-100 hover:border-gray-300 bg-white'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs" style={{backgroundColor: item.color}}>
                                                    {item.name[0]}
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className={`font-bold text-sm ${item.isCheapest ? 'text-red-700' : 'text-gray-700'}`}>{item.name}</span>
                                                    {item.isCheapest && <span className="text-[10px] text-red-500 font-bold flex items-center gap-1"><TrendingDown size={10}/> 全网最低</span>}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`text-lg font-black font-mono ${item.isCheapest ? 'text-red-600' : 'text-gray-800'}`}>
                                                    ¥{item.price}
                                                </span>
                                                <ExternalLink size={14} className="text-gray-300 group-hover:text-gray-500" />
                                            </div>
                                        </a>
                                    ))}
                                </div>

                                <button onClick={handleCooldown} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition-colors">
                                    扫描下一个商品
                                </button>
                            </div>
                        </div>
                    </div>
                )}
              </div>
            </div>
          );
        }

        // --- 4. 渲染到页面 ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SmartPriceScanner />);
    </script>
</body>
</html>
