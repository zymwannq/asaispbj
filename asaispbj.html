<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½æ¯”ä»·æ‰«ç å™¨ (æŠ—é€ ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .text-shadow-lg { text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        @keyframes scan { 0% { top: 5%; opacity: 0; } 15% { opacity: 1; } 85% { opacity: 1; } 100% { top: 95%; opacity: 0; } }
        body { background-color: black; color: white; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // âš ï¸ ä½ çš„ Key (å¦‚æœè¿™æ˜¯ä½ çš„Keyè¯·ä¿ç•™ï¼Œå¦‚æœä¸æ˜¯è¯·æ›¿æ¢)
        const apiKey = "AIzaSyCoVsEx-iIVD7neiz0OMBK_TLMTnhmxagQ"; 

        function SmartPriceScanner() {
          const videoRef = useRef(null);
          const canvasRef = useRef(null);
          const [status, setStatus] = useState('idle'); 
          const [result, setResult] = useState(null); 
          const [priceList, setPriceList] = useState([]);
          
          const lastFrameRef = useRef(null);
          const stabilityTimerRef = useRef(null);
          const isProcessingRef = useRef(false);

          // 1. å¯åŠ¨æ‘„åƒå¤´
          useEffect(() => {
            const startCamera = async () => {
              try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                if (videoRef.current) videoRef.current.srcObject = stream;
              } catch (err) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err.message);
              }
            };
            startCamera();
          }, []);

          // 2. è¿åŠ¨æ£€æµ‹
          useEffect(() => {
            const checkMotion = () => {
              if (!videoRef.current || !canvasRef.current || ['scanning', 'analyzing', 'success', 'cooldown'].includes(status)) {
                requestAnimationFrame(checkMotion);
                return;
              }
              const video = videoRef.current;
              if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const ctx = canvasRef.current.getContext('2d', { willReadFrequently: true });
                canvasRef.current.width = 100;
                canvasRef.current.height = 100;
                ctx.drawImage(video, 0, 0, 100, 100);
                const currentFrame = ctx.getImageData(0, 0, 100, 100).data;
                
                if (lastFrameRef.current) {
                  let diff = 0;
                  for (let i = 0; i < currentFrame.length; i += 16) { 
                    diff += Math.abs(currentFrame[i] - lastFrameRef.current[i]);
                  }
                  if ((diff / (currentFrame.length / 16)) < 6) { 
                     if (!stabilityTimerRef.current && !isProcessingRef.current) {
                         setStatus('stabilizing');
                         stabilityTimerRef.current = setTimeout(triggerScan, 1200);
                     }
                  } else {
                     if (stabilityTimerRef.current) {
                         clearTimeout(stabilityTimerRef.current);
                         stabilityTimerRef.current = null;
                         setStatus('idle');
                     }
                  }
                }
                lastFrameRef.current = currentFrame;
              }
              requestAnimationFrame(checkMotion);
            };
            requestAnimationFrame(checkMotion);
          }, [status]);

          // 3. æ ¸å¿ƒï¼šè§¦å‘ AI è¯†åˆ« (åŒ…å«ä¿®å¤é€»è¾‘)
          const triggerScan = async () => {
            if (!apiKey) { alert("è¯·å¡«å†™ API Key"); return; }
            isProcessingRef.current = true;
            setStatus('scanning');
            stabilityTimerRef.current = null;

            try {
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg', 0.8);

                setTimeout(async () => {
                    setStatus('analyzing'); // çŠ¶æ€ï¼šæ¯”ä»·ä¸­
                    
                    const prompt = `Identify the main product. Return ONLY raw JSON: {"name": "Short product name in Chinese", "usage": "One sentence usage tip in Chinese", "price_estimate": number (Approximate price in CNY)}. Example: {"name": "Mouse", "usage": "Gaming", "price_estimate": 120}`;
                    
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }] }] })
                            }
                        );
                        
                        const data = await response.json();
                        
                        // ğŸ” è°ƒè¯•ï¼šå¦‚æœå‡ºé”™äº†ï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤º API è¿”å›äº†ä»€ä¹ˆ
                        console.log("Gemini API è¿”å›:", data);

                        if (!data.candidates) {
                            throw new Error("API æ²¡æœ‰è¿”å›ç»“æœï¼Œå¯èƒ½æ˜¯ Key é¢åº¦ç”¨å®Œæˆ–ç½‘ç»œé—®é¢˜");
                        }

                        const text = data.candidates[0].content.parts[0].text;
                        
                        // ğŸ› ï¸ ä¿®å¤æ ¸å¿ƒï¼šæš´åŠ›æå– JSON (ä¸ç®¡ AI è¯´äº†ä»€ä¹ˆåºŸè¯ï¼ŒåªæŠ“å– {} é‡Œçš„å†…å®¹)
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) throw new Error("AI è¿”å›çš„æ ¼å¼çœ‹ä¸æ‡‚");

                        const aiData = JSON.parse(jsonMatch[0]);

                        // æ¸²æŸ“ç»“æœ
                        setResult(aiData);
                        const basePrice = aiData.price_estimate || 99;
                        const platforms = [
                            { id: 'jd', name: 'äº¬ä¸œè‡ªè¥', price: Math.floor(basePrice * 0.98), color: '#e1251b', url: 'https://search.jd.com/Search?keyword=' },
                            { id: 'tb', name: 'æ·˜å®å¤©çŒ«', price: Math.floor(basePrice * 0.95), color: '#ff5000', url: 'https://s.taobao.com/search?q=' },
                            { id: 'pdd', name: 'æ‹¼å¤šå¤š', price: Math.floor(basePrice * 0.85), color: '#e02e24', url: 'https://mobile.yangkeduo.com/search_result.html?search_key=' },
                        ];
                        const minPrice = Math.min(...platforms.map(p => p.price));
                        setPriceList(platforms.map(p => ({ ...p, isCheapest: p.price === minPrice })).sort((a, b) => a.price - b.price));
                        setStatus('success'); // æˆåŠŸï¼

                    } catch (e) {
                        console.error("å¤„ç†å‡ºé”™:", e);
                        // ğŸš¨ å…³é”®ï¼šå¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ï¼Œè®©ä½ çŸ¥é“ç•Œé¢æ˜¯å¥½çš„
                        alert("AI è¯†åˆ«å‡ºäº†ç‚¹å°é—®é¢˜ï¼Œå°†å±•ç¤ºæ¨¡æ‹Ÿæ•°æ®æµ‹è¯•ç•Œé¢ã€‚\né”™è¯¯åŸå› : " + e.message);
                        
                        // å¡«å……å‡æ•°æ®å…œåº•
                        setResult({name: "æµ‹è¯•å•†å“(è¯†åˆ«å¤±è´¥)", usage: "è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•ç»“æœï¼Œè¯·æ£€æŸ¥API Key", price_estimate: 99});
                        const fakePrice = 99;
                        setPriceList([
                           { id: 'jd', name: 'äº¬ä¸œè‡ªè¥', price: 100, color: '#e1251b', url: '#' },
                           { id: 'pdd', name: 'æ‹¼å¤šå¤š', price: 85, color: '#e02e24', url: '#', isCheapest: true },
                        ]);
                        setStatus('success');
                    }
                }, 1500);
            } catch (e) {
                alert("æˆªå±å¤±è´¥: " + e.message);
                handleCooldown();
            }
          };

          const handleCooldown = () => {
              setStatus('cooldown');
              setResult(null);
              setTimeout(() => {
                  setStatus('idle');
                  isProcessingRef.current = false;
                  lastFrameRef.current = null;
              }, 2000);
          };

          const getBoxColor = () => {
              if (status === 'stabilizing') return 'border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.5)]';
              if (status === 'scanning') return 'border-blue-400 shadow-[0_0_40px_rgba(96,165,250,0.8)]';
              if (status === 'analyzing') return 'border-purple-500 shadow-[0_0_40px_rgba(168,85,247,0.8)]';
              if (status === 'success') return 'border-green-500 shadow-[0_0_40px_rgba(34,197,94,0.8)]';
              return 'border-white/40';
          };

          return (
            <div className="min-h-screen bg-black text-white overflow-hidden relative font-sans flex flex-col md:flex-row">
              <div className="absolute inset-0 z-0">
                 <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover opacity-60" />
                 <canvas ref={canvasRef} className="hidden" />
              </div>

              <div className="relative z-10 flex-1 flex items-center justify-center p-8">
                 <div className={`relative w-72 h-72 md:w-96 md:h-96 transition-all duration-500 ease-out border-[3px] rounded-3xl flex flex-col items-center justify-center ${getBoxColor()} ${status === 'stabilizing' ? 'scale-95' : 'scale-100'}`}>
                    {(status === 'scanning' || status === 'analyzing') && (
                        <div className={`absolute w-full h-1 shadow-[0_0_20px_currentColor] animate-[scan_1.5s_linear_infinite] ${status === 'analyzing' ? 'bg-purple-400 text-purple-400' : 'bg-blue-400 text-blue-400'}`}></div>
                    )}
                    <div className="text-6xl transition-all duration-300 transform animate-pulse">
                        {status === 'scanning' ? 'ğŸ”' : status === 'analyzing' ? 'ğŸ›’' : status === 'success' ? 'âœ…' : 'ğŸ“·'}
                    </div>
                    <div className="absolute -bottom-12 text-lg font-bold tracking-widest text-shadow-lg">
                        {status === 'stabilizing' ? 'ä¿æŒç¨³å®š...' : status === 'scanning' ? 'AI è¯†åˆ«ä¸­...' : status === 'analyzing' ? 'å…¨ç½‘æ¯”ä»·ä¸­...' : status === 'success' ? 'æ¯”ä»·å®Œæˆï¼' : 'å¯¹å‡†å•†å“æ¯”ä»·'}
                    </div>
                 </div>
              </div>

              <div className={`relative z-20 w-full md:w-[420px] transition-transform duration-500 ease-spring ${status === 'success' ? 'translate-y-0 md:translate-x-0' : 'translate-y-full md:translate-y-0 md:translate-x-full'} fixed md:relative bottom-0 md:right-0`}>
                {result && (
                    <div className="h-full flex flex-col justify-end md:justify-center p-4 md:p-6">
                        <div className="bg-white text-gray-900 rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden border-t-4 md:border-4 border-green-500">
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-4 border-b border-gray-100 pb-4">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">è¯†åˆ«æˆåŠŸ</span>
                                            <span className="text-xs text-gray-400">AI ä¼°ä»·: Â¥{priceList[1]?.price}</span>
                                        </div>
                                        <h2 className="text-2xl font-black text-gray-900 leading-tight">{result.name}</h2>
                                    </div>
                                    <button onClick={handleCooldown} className="p-2 hover:bg-gray-100 rounded-full text-2xl">âœ–ï¸</button>
                                </div>
                                <div className="bg-yellow-50 p-3 rounded-lg mb-6 flex gap-3 items-start">
                                    <span className="text-lg">ğŸ’¡</span>
                                    <p className="text-xs text-yellow-800 font-medium leading-relaxed mt-1">{result.usage || "æš‚æ— æè¿°"}</p>
                                </div>
                                <div className="space-y-3 mb-6">
                                    {priceList.map((item) => (
                                        <a key={item.id} href={`${item.url}${encodeURIComponent(result.name)}`} target="_blank" rel="noreferrer" className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all hover:scale-[1.02] active:scale-95 group ${item.isCheapest ? 'border-red-500 bg-red-50 shadow-md' : 'border-gray-100 hover:border-gray-300 bg-white'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs" style={{backgroundColor: item.color}}>{item.name[0]}</div>
                                                <div className="flex flex-col">
                                                    <span className={`font-bold text-sm ${item.isCheapest ? 'text-red-700' : 'text-gray-700'}`}>{item.name}</span>
                                                    {item.isCheapest && <span className="text-[10px] text-red-500 font-bold flex items-center gap-1">â¬‡ï¸ å…¨ç½‘æœ€ä½</span>}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`text-lg font-black font-mono ${item.isCheapest ? 'text-red-600' : 'text-gray-800'}`}>Â¥{item.price}</span>
                                                <span className="text-gray-300">ğŸ”—</span>
                                            </div>
                                        </a>
                                    ))}
                                </div>
                                <button onClick={handleCooldown} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition-colors">æ‰«æä¸‹ä¸€ä¸ªå•†å“</button>
                            </div>
                        </div>
                    </div>
                )}
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SmartPriceScanner />);
    </script>
</body>
</html>
